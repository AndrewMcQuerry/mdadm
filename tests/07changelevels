
# Test changing of level, chunksize etc.
# Create a RAID1, convert to RAID5, add a disk, add another disk
# convert to RAID6, back to RAID5 and ultimately to RAID1

testK=$[64*3*6]
dd if=/dev/urandom of=/tmp/RandFile bs=1024 count=$testK
export MDADM_GROW_VERIFY=1

dotest() {
 sleep 0.5
 check wait
 testdev $md0 $1 $mdsize0 64 nd
 blockdev --flushbufs $md0
 cmp -s -n $[textK*1024] $md0 /tmp/RandFile || { echo cmp failed; exit 2; }
 # write something new - shift chars 4 space
 tr ' -~' '$-~ -#' < /tmp/RandFile > /tmp/RandFile2
 mv /tmp/RandFile2 /tmp/RandFile
 dd if=/tmp/RandFile of=$md0
}

bu=/tmp/md-test-backup
rm -f $bu
mdadm -CR $md0 -l1 -n2 -x1 $dev0 $dev1 $dev2
testdev $md0 1 $mdsize0 64
dd if=/tmp/RandFile of=$md0
dotest 1

mdadm --grow $md0 -l5 -n3 --chunk 64
dotest 2

mdadm $md0 --add $dev3 $dev4
mdadm --grow $md0 -n4 --chunk 32
dotest 3

mdadm -G $md0 -l6 --backup-file $bu
dotest 3

mdadm -G /dev/md0 --array-size $[mdsize0*2]
mdadm -G $md0 -n4 --backup-file $bu
dotest 2

mdadm -G $md0 -l5 --backup-file $bu
dotest 2

mdadm -G /dev/md0 --array-size $mdsize0
mdadm -G $md0 -n2 --backup-file $bu
dotest 1

mdadm -G --level=1 $md0
dotest 1
